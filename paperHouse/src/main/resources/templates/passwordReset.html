<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
  <head th:replace="fragments/config :: configFragment"></head>
  <body>
    <div>
      <p>가입하실 때 입력하신 이메일을 입력해주세요</p>
      <br />
      <input type="email" name="username" placeholder="이메일" id="email" />
      <button type="button" id="emailPost">비밀번호 재설정</button>
    </div>
    <br />
    <div id="checkView">
      <input type="email" id="num" name="num" placeholder="인증번호" />&nbsp;<button type="button" id="numCheck">인증번호 확인</button>
      <p id="remain" style="color: blue; font-size: 5px"></p>
    </div>

    <script type="application/javascript" th:inline="javascript">
      $(function () {
        var csrfToken = /*[[${_csrf.token}]]*/ null;
        var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
        $(document).ajaxSend(function (e, xhr, options) {
          xhr.setRequestHeader(csrfHeader, csrfToken);
        });
      });
    </script>

    <script type="text/javascript">
      let email = "";
      let check = true;

      $(document).ready(function () {
        $("#checkView").hide();
      });

      // 인증번호 발송
      $("#emailPost").click(function () {
        email = $("#email").val();

        let exptext = /^[A-Za-z0-9_\.\-]+@[A-Za-z0-9\-]+\.[A-Za-z0-9\-]+/;

        if (exptext.test(email) == false || email == "") {
          swal("", "이메일 형식이 올바르지 않습니다.", "error");

          $("#email").focus();
        } else {
          $.ajax({
            type: "GET",
            url: "/resetPwd",
            data: { email: email },

            success: function (str) {
              if (str == "NO") {
                swal("", "등록되지 않은 사용자입니다", "error");
              } else {
                swal("인증번호", "인증번호가 성공적으로 발송되었습니다", "success");
                $("#checkView").show();
                countdown();
                var date = new Date();
                date.setTime(date.getTime() + 5 * 60 * 1000);
                $.cookie(email, str, { expires: date, path: "/" });
              }
            },
            error: function () {
              swal("", "오류: 관리자에게 문의하세요", "error");
            },
          });
        }
      });

      // 인증번호 확인
      $("#numCheck").click(function () {
        let num = $("#num").val();
        let r_num = $.cookie(email);

        if (num != r_num) {
          swal("", "인증번호가 다릅니다", "error");
        } else {
          $.ajax({
            type: "POST",
            url: "/user/resetPassword/result",
            data: { pwd: num, email: email },
            success: function () {
              swal("임시비밀번호로 변경되었습니다").then(function () {
                window.close();
                $("#checkView").hide();
              });
            },
            error: function () {
              alert("error");
            },
          });
        }
      });

      // 인증번호 인증시간
      function countdown() {
        if (countdown.expiredTime == null) {
          countdown.expiredTime = new Date().getTime() + 1000 * 60 * 5; //5분
        }
        countdown.remainSeconds = parseInt((countdown.expiredTime - new Date().getTime()) / 1000);
        if (countdown.remainSeconds < 0) {
          $("#remain").css("color", "red");
          $("#remain").text("인증시간 초과");
        } else {
          $("#remain").text("남은시간 " + parseInt(countdown.remainSeconds / 60) + ":" + new String(countdown.remainSeconds % 60).padStart(2, "0"));
          setTimeout(countdown, 1000);
        }
      }
    </script>
  </body>
</html>
