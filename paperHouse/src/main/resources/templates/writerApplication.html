<!DOCTYPE html>
<html
  xmlns="http://www.w3.org/1999/xhtml"
  xmlns:th="http://www.thymeleaf.org"
  xmlns:sec="http://www.thymeleaf.org/thymeleaf-extras-springsecurity5"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
>
  <head th:replace="fragments/config :: configFragment"></head>
<body>

<form th:action="@{/writer/application/appComplete}" id="form" name="form" method="POST" enctype="multipart/form-data">
<input type="hidden" class="apply" id="userSeq" name="userSeq" th:value="${param.userSeq}"> 


<div>
	<div class="img_wrap">
		<img id="profile-image" border="1" src="/static/profile/profiledefault.png"/>
	</div>
</div>
	<input type="file" class="apply" id="profile" name="profile" onchange="validateimg(this)"/>

<br>

<div>작가명</div>
<input type="text" class="apply" id="writerName" name="writerName" placeholder="작가명">	

<br><br>

<div>대표 소개 한줄</div>
<input type="text" class="apply" id="intro" name="intro" placeholder="내용을 입력해주세요.">

<br><br>

<div>작가 이력</div>
<input type="text" class="apply" id="history" name="history" placeholder="내용을 입력해주세요.">

<div>본인 소설 1편 업로드</div>
<input  type="file" class="apply" id="newWriting" name="newWriting" accept=".txt" onchange="validatetxt(this)"/>

<br><br>
<div>PR글 작성</div>
<textarea rows="10" cols="50" class="apply" id="publicRelations" name="publicRelations"></textarea>

<br><br>

<input type="submit" id="submitbtn"  value="작가신청하기">

</form>


<script type="application/javascript" th:inline="javascript">
  $(function () {
    var csrfToken = /*[[${_csrf.token}]]*/ null;
    var csrfHeader = /*[[${_csrf.headerName}]]*/ null;
    $(document).ajaxSend(function (e, xhr, options) {
      xhr.setRequestHeader(csrfHeader, csrfToken);
    });
  });
</script>

<script type="text/javascript">

function validateimg(ctrl) { 
    var fileUpload = ctrl;
    var regex = new RegExp("([a-zA-Z0-9\s_\\.\-:])+(.jpg|.png|.gif)$");
    if (regex.test(fileUpload.value.toLowerCase())) {
        if (typeof (fileUpload.files) != "undefined") {
            var reader = new FileReader();
            reader.readAsDataURL(fileUpload.files[0]);
            reader.onload = function (e) {
                var image = new Image();
                image.src = e.target.result;
                image.onload = function () {
                    var height = this.height;
                    var width = this.width;
                    if (height != 180 && width != 180) {
                    	swal("","프로필 사진의 사이즈는 180 x 180px입니다.","error");
                        return false;
                    }else{
                    	swal("good!","이미지가 정상적으로 업로드 되었습니다.","success");
                        $("#profile-image").attr("src", e.target.result);
                        return true;
                    }
                };
            }
        } else {
        	swal("","이 브라우저는 HTML5를 지원하지 않습니다.","error");
            return false;
        }
    } else {
    	swal("","올바른 파일(jpg/.png/.gif)을 선택해주세요.","error");
        return false;
    }
}

function validatetxt(file) {
    var FileSize = file.files[0].size / 1024 / 1024; // in MB
    console.log(FileSize);
    if (FileSize > 2) {
    	swal("","텍스트 파일을 2MB이내로 업로드 해주세요.","error");
        $("#newWriting").val(''); //for clearing with Jquery
    }
}

$(document).ready(function(){
	$("#submitbtn").click(function (e) { 
		e.preventDefault();
		
		if($("#profile").val().trim() == ""){
			$("#profile").val("");
			$("#profile").focus();
			 swal("","프로필 사진을 업로드 해주세요.","error");
			 return false;
		} else if($("#writerName").val().trim() == "") {
			$("#writerName").val("");
			$("#writerName").focus();
			 swal("","작가 이름을 작성 해주세요.","error");
			 return false;
		} else if($("#intro").val().trim() == "") {
			$("#intro").val("");
			$("#intro").focus();
			 swal("","대표 소개 한줄을 작성 해주세요.","error");
			 return false;
		} else if($("#history").val().trim() == "") {
			$("#history").val("");
			$("#history").focus();
			 swal("","작가 이력을 작성 해주세요.","error");
			 return false;
		} else if($("#newWriting").val().trim() == "") {
			$("#newWriting").val("");
			$("#newWriting").focus();
			 swal("","소설을 업로드 해주세요.","error");
			 return false;
		} else if($("#publicRelations").val().trim() == "") {
			$("#publicRelations").val("");
			$("#publicRelations").focus();
			 swal("","PR글을 작성 해주세요.","error");
			 return false;
		} else {
			
			$.ajax({
				url:"/writer/apply",
				type:"post",
				contentType: "application/x-www-form-urlencoded; charset=UTF-8",
				datatype:'json',
				data:{userSeq:$("#userSeq").val()},
				async:true,	
				success:function( resp ){
					
					if(resp == "ok"){
						swal({
						    title: "good!",
						    text: "작가 신청이 완료되었습니다!",
						    type: "success"
						}).then(function() {
							$("#form").submit();
						});
					}else {
						swal({
						    title: "error",
						    text: "이미 작가 신청 하셨습니다.",
						    type: "error"
						}).then(function() {
							return false;
						});
					}
			});	
		}
	});
});
</script>
</body>
</html>

